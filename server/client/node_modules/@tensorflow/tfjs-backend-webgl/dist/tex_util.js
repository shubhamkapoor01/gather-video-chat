/**
 * @license
 * Copyright 2017 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import { env, util } from '@tensorflow/tfjs-core';
export var PackingScheme;
(function (PackingScheme) {
    /**
     * All values in a single texel are densely packed without any constraints.
     *
     * This is how the shader encodes a tensor with shape = [2, 3, 4]
     * (indices are [batch, row, col]).
     *
     * 000|001   010|011   020|021
     * -------   -------   -------
     * 002|003   012|013   022|023
     *
     * 100|101   110|111   120|121
     * -------   -------   -------
     * 102|103   112|113   122|123
     *
     */
    PackingScheme[PackingScheme["DENSE"] = 0] = "DENSE";
    /**
     * Single texels contain only values from the same batch, and from adjacent
     * rows and columns.
     *
     * This is how the shader encodes a tensor with shape = [2, 3, 5]
     * (indices are [batch, row, col]).
     *
     * 000|001   002|003   004|xxx   020|021   022|023   024|xxx
     * -------   -------   -------   -------   -------   -------
     * 010|011   012|013   014|xxx   xxx|xxx   xxx|xxx   xxx|xxx
     *
     * 100|101   102|103   104|xxx   120|121   122|123   124|xxx
     * -------   -------   -------   -------   -------   -------
     * 110|111   112|113   114|xxx   xxx|xxx   xxx|xxx   xxx|xxx
     *
     */
    PackingScheme[PackingScheme["SHARED_BATCH"] = 1] = "SHARED_BATCH";
})(PackingScheme || (PackingScheme = {}));
export var TextureUsage;
(function (TextureUsage) {
    TextureUsage[TextureUsage["RENDER"] = 0] = "RENDER";
    TextureUsage[TextureUsage["UPLOAD"] = 1] = "UPLOAD";
    TextureUsage[TextureUsage["PIXELS"] = 2] = "PIXELS";
    TextureUsage[TextureUsage["DOWNLOAD"] = 3] = "DOWNLOAD";
})(TextureUsage || (TextureUsage = {}));
export var PhysicalTextureType;
(function (PhysicalTextureType) {
    PhysicalTextureType[PhysicalTextureType["UNPACKED_FLOAT16"] = 0] = "UNPACKED_FLOAT16";
    PhysicalTextureType[PhysicalTextureType["UNPACKED_FLOAT32"] = 1] = "UNPACKED_FLOAT32";
    PhysicalTextureType[PhysicalTextureType["PACKED_4X1_UNSIGNED_BYTE"] = 2] = "PACKED_4X1_UNSIGNED_BYTE";
    PhysicalTextureType[PhysicalTextureType["PACKED_2X2_FLOAT32"] = 3] = "PACKED_2X2_FLOAT32";
    PhysicalTextureType[PhysicalTextureType["PACKED_2X2_FLOAT16"] = 4] = "PACKED_2X2_FLOAT16";
})(PhysicalTextureType || (PhysicalTextureType = {}));
export function getUnpackedMatrixTextureShapeWidthHeight(rows, columns) {
    return [columns, rows];
}
export function getUnpackedArraySizeFromMatrixSize(matrixSize, channelsPerTexture) {
    return matrixSize * channelsPerTexture;
}
export function getColorMatrixTextureShapeWidthHeight(rows, columns) {
    return [columns * 4, rows];
}
/**
 * Get shape for densely packed RGBA texture.
 */
export function getDenseTexShape(shape) {
    const size = util.sizeFromShape(shape);
    const texelsNeeded = Math.ceil(size / 4);
    return util.sizeToSquarishShape(texelsNeeded);
}
export function getMatrixSizeFromUnpackedArraySize(unpackedSize, channelsPerTexture) {
    if (unpackedSize % channelsPerTexture !== 0) {
        throw new Error(`unpackedSize (${unpackedSize}) must be a multiple of ` +
            `${channelsPerTexture}`);
    }
    return unpackedSize / channelsPerTexture;
}
export function decodeMatrixFromUnpackedColorRGBAArray(unpackedArray, matrix, channels) {
    const requiredSize = unpackedArray.length * channels / 4;
    if (matrix.length < requiredSize) {
        throw new Error(`matrix length (${matrix.length}) must be >= ${requiredSize}`);
    }
    let dst = 0;
    for (let src = 0; src < unpackedArray.length; src += 4) {
        for (let c = 0; c < channels; c++) {
            matrix[dst++] = unpackedArray[src + c];
        }
    }
}
export function getPackedMatrixTextureShapeWidthHeight(rows, columns) {
    return [
        Math.max(1, Math.ceil(columns / 2)), Math.max(1, Math.ceil(rows / 2))
    ];
}
export function getPackedRGBAArraySizeFromMatrixShape(rows, columns) {
    const [w, h] = getPackedMatrixTextureShapeWidthHeight(rows, columns);
    return w * h * 4;
}
export function getTextureConfig(
// tslint:disable-next-line:no-any
gl, textureHalfFloatExtension) {
    // tslint:disable-next-line:no-any
    const glany = gl;
    let internalFormatFloat;
    let internalFormatHalfFloat;
    let internalFormatPackedHalfFloat;
    let internalFormatPackedFloat;
    let textureFormatFloat;
    let downloadTextureFormat;
    let downloadUnpackNumChannels;
    let defaultNumChannels;
    let textureTypeHalfFloat;
    let textureTypeFloat;
    if (env().getNumber('WEBGL_VERSION') === 2) {
        internalFormatFloat = glany.R32F;
        internalFormatHalfFloat = glany.R16F;
        internalFormatPackedHalfFloat = glany.RGBA16F;
        internalFormatPackedFloat = glany.RGBA32F;
        textureFormatFloat = glany.RED;
        downloadUnpackNumChannels = 4;
        defaultNumChannels = 1;
        textureTypeHalfFloat = glany.HALF_FLOAT;
        textureTypeFloat = glany.FLOAT;
    }
    else {
        internalFormatFloat = gl.RGBA;
        internalFormatHalfFloat = gl.RGBA;
        internalFormatPackedHalfFloat = gl.RGBA;
        internalFormatPackedFloat = glany.RGBA;
        textureFormatFloat = gl.RGBA;
        downloadUnpackNumChannels = 4;
        defaultNumChannels = 4;
        textureTypeHalfFloat = textureHalfFloatExtension != null ?
            textureHalfFloatExtension.HALF_FLOAT_OES :
            null;
        textureTypeFloat = gl.FLOAT;
    }
    downloadTextureFormat = gl.RGBA;
    return {
        internalFormatFloat,
        internalFormatHalfFloat,
        internalFormatPackedHalfFloat,
        internalFormatPackedFloat,
        textureFormatFloat,
        downloadTextureFormat,
        downloadUnpackNumChannels,
        defaultNumChannels,
        textureTypeHalfFloat,
        textureTypeFloat
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4X3V0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ2wvc3JjL3RleF91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUVILE9BQU8sRUFBaUMsR0FBRyxFQUFjLElBQUksRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBRTVGLE1BQU0sQ0FBTixJQUFZLGFBbUNYO0FBbkNELFdBQVksYUFBYTtJQUN2Qjs7Ozs7Ozs7Ozs7Ozs7T0FjRztJQUNILG1EQUFLLENBQUE7SUFFTDs7Ozs7Ozs7Ozs7Ozs7O09BZUc7SUFDSCxpRUFBWSxDQUFBO0FBQ2QsQ0FBQyxFQW5DVyxhQUFhLEtBQWIsYUFBYSxRQW1DeEI7QUFFRCxNQUFNLENBQU4sSUFBWSxZQUtYO0FBTEQsV0FBWSxZQUFZO0lBQ3RCLG1EQUFNLENBQUE7SUFDTixtREFBTSxDQUFBO0lBQ04sbURBQU0sQ0FBQTtJQUNOLHVEQUFRLENBQUE7QUFDVixDQUFDLEVBTFcsWUFBWSxLQUFaLFlBQVksUUFLdkI7QUFFRCxNQUFNLENBQU4sSUFBWSxtQkFNWDtBQU5ELFdBQVksbUJBQW1CO0lBQzdCLHFGQUFnQixDQUFBO0lBQ2hCLHFGQUFnQixDQUFBO0lBQ2hCLHFHQUF3QixDQUFBO0lBQ3hCLHlGQUFrQixDQUFBO0lBQ2xCLHlGQUFrQixDQUFBO0FBQ3BCLENBQUMsRUFOVyxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBTTlCO0FBOEJELE1BQU0sVUFBVSx3Q0FBd0MsQ0FDcEQsSUFBWSxFQUFFLE9BQWU7SUFDL0IsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN6QixDQUFDO0FBRUQsTUFBTSxVQUFVLGtDQUFrQyxDQUM5QyxVQUFrQixFQUFFLGtCQUEwQjtJQUNoRCxPQUFPLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQztBQUN6QyxDQUFDO0FBRUQsTUFBTSxVQUFVLHFDQUFxQyxD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LGtCQUFrQjtRQUNsQixvQkFBb0I7UUFDcEIsZ0JBQWdCO0tBQ2pCLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTcgR29vZ2xlIExMQy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqL1xuXG5pbXBvcnQge2JhY2tlbmRfdXRpbCwgRGF0YUlkLCBEYXRhVHlwZSwgZW52LCBUZW5zb3JJbmZvLCB1dGlsfSBmcm9tICdAdGVuc29yZmxvdy90ZmpzLWNvcmUnO1xuXG5leHBvcnQgZW51bSBQYWNraW5nU2NoZW1lIHtcbiAgLyoqXG4gICAqIEFsbCB2YWx1ZXMgaW4gYSBzaW5nbGUgdGV4ZWwgYXJlIGRlbnNlbHkgcGFja2VkIHdpdGhvdXQgYW55IGNvbnN0cmFpbnRzLlxuICAgKlxuICAgKiBUaGlzIGlzIGhvdyB0aGUgc2hhZGVyIGVuY29kZXMgYSB0ZW5zb3Igd2l0aCBzaGFwZSA9IFsyLCAzLCA0XVxuICAgKiAoaW5kaWNlcyBhcmUgW2JhdGNoLCByb3csIGNvbF0pLlxuICAgKlxuICAgKiAwMDB8MDAxICAgMDEwfDAxMSAgIDAyMHwwMjFcbiAgICogLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tXG4gICAqIDAwMnwwMDMgICAwMTJ8MDEzICAgMDIyfDAyM1xuICAgKlxuICAgKiAxMDB8MTAxICAgMTEwfDExMSAgIDEyMHwxMjFcbiAgICogLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tXG4gICAqIDEwMnwxMDMgICAxMTJ8MTEzICAgMTIyfDEyM1xuICAgKlxuICAgKi9cbiAgREVOU0UsXG5cbiAgLyoqXG4gICAqIFNpbmdsZSB0ZXhlbHMgY29udGFpbiBvbmx5IHZhbHVlcyBmcm9tIHRoZSBzYW1lIGJhdGNoLCBhbmQgZnJvbSBhZGphY2VudFxuICAgKiByb3dzIGFuZCBjb2x1bW5zLlxuICAgKlxuICAgKiBUaGlzIGlzIGhvdyB0aGUgc2hhZGVyIGVuY29kZXMgYSB0ZW5zb3Igd2l0aCBzaGFwZSA9IFsyLCAzLCA1XVxuICAgKiAoaW5kaWNlcyBhcmUgW2JhdGNoLCByb3csIGNvbF0pLlxuICAgKlxuICAgKiAwMDB8MDAxICAgMDAyfDAwMyAgIDAwNHx4eHggICAwMjB8MDIxICAgMDIyfDAyMyAgIDAyNHx4eHhcbiAgICogLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tICAgLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tXG4gICAqIDAxMHwwMTEgICAwMTJ8MDEzICAgMDE0fHh4eCAgIHh4eHx4eHggICB4eHh8eHh4ICAgeHh4fHh4eFxuICAgKlxuICAgKiAxMDB8MTAxICAgMTAyfDEwMyAgIDEwNHx4eHggICAxMjB8MTIxICAgMTIyfDEyMyAgIDEyNHx4eHhcbiAgICogLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tICAgLS0tLS0tLSAgIC0tLS0tLS0gICAtLS0tLS0tXG4gICAqIDExMHwxMTEgICAxMTJ8MTEzICAgMTE0fHh4eCAgIHh4eHx4eHggICB4eHh8eHh4ICAgeHh4fHh4eFxuICAgKlxuICAgKi9cbiAgU0hBUkVEX0JBVENIXG59XG5cbmV4cG9ydCBlbnVtIFRleHR1cmVVc2FnZSB7XG4gIFJFTkRFUixcbiAgVVBMT0FELFxuICBQSVhFTFMsXG4gIERPV05MT0FEXG59XG5cbmV4cG9ydCBlbnVtIFBoeXNpY2FsVGV4dHVyZVR5cGUge1xuICBVTlBBQ0tFRF9GTE9BVDE2LFxuICBVTlBBQ0tFRF9GTE9BVDMyLFxuICBQQUNLRURfNFgxX1VOU0lHTkVEX0JZVEUsXG4gIFBBQ0tFRF8yWDJfRkxPQVQzMixcbiAgUEFDS0VEXzJYMl9GTE9BVDE2XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGV4dHVyZURhdGEge1xuICAvLyBSZXF1aXJlZC5cbiAgc2hhcGU6IG51bWJlcltdO1xuICBkdHlwZTogRGF0YVR5cGU7XG5cbiAgLy8gT3B0aW9uYWwuXG4gIHZhbHVlcz86IGJhY2tlbmRfdXRpbC5CYWNrZW5kVmFsdWVzO1xuICB0ZXh0dXJlPzogV2ViR0xUZXh0dXJlO1xuICAvLyBGb3IgY29tcGxleCBudW1iZXJzLCB0aGUgcmVhbCBhbmQgaW1hZ2luYXJ5IHBhcnRzIGFyZSBzdG9yZWQgYXMgdGhlaXIgb3duXG4gIC8vIGluZGl2aWR1YWwgdGVuc29ySW5mb3MsIHdpdGggYSBwYXJlbnQgam9pbmluZyB0aGUgdHdvIHdpdGggdGhlXG4gIC8vIGNvbXBsZXhUZW5zb3JzIGZpZWxkLiBXaGVuIHRoaXMgaXMgZGVmaW5lZCwgdGV4dHVyZSB3aWxsIGJlIG51bGwuXG4gIGNvbXBsZXhUZW5zb3JJbmZvcz86IHtyZWFsOiBUZW5zb3JJbmZvLCBpbWFnOiBUZW5zb3JJbmZvfTtcbiAgLyoqIFtyb3dzLCBjb2x1bW5zXSBzaGFwZSBvZiB0aGUgdGV4dHVyZS4gKi9cbiAgdGV4U2hhcGU/OiBbbnVtYmVyLCBudW1iZXJdO1xuICB1c2FnZT86IFRleHR1cmVVc2FnZTtcbiAgaXNQYWNrZWQ/OiBib29sZWFuO1xuXG4gIHJlZkNvdW50OiBudW1iZXI7XG5cbiAgLy8gQXZhaWxhYmxlIHdoZW4gdGhlIHRlbnNvciBoYXMgYmVlbiBzbGljZWQuXG4gIHNsaWNlPzoge1xuICAgIC8vIE9mZnNldCBpbiB0aGUgJ2ZsYXQgaW5kZXgnIHNwYWNlLlxuICAgIGZsYXRPZmZzZXQ6IG51bWJlcjtcbiAgICAvLyBVc2VkIGZvciBjb3VudGluZyBob3cgbWFueSBzbGljZWQgdGVuc29ycyBwb2ludCB0byB0aGUgc2FtZSB0ZXh0dXJlLlxuICAgIG9yaWdEYXRhSWQ6IERhdGFJZDtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFVucGFja2VkTWF0cml4VGV4dHVyZVNoYXBlV2lkdGhIZWlnaHQoXG4gICAgcm93czogbnVtYmVyLCBjb2x1bW5zOiBudW1iZXIpOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgcmV0dXJuIFtjb2x1bW5zLCByb3dzXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFVucGFja2VkQXJyYXlTaXplRnJvbU1hdHJpeFNpemUoXG4gICAgbWF0cml4U2l6ZTogbnVtYmVyLCBjaGFubmVsc1BlclRleHR1cmU6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiBtYXRyaXhTaXplICogY2hhbm5lbHNQZXJUZXh0dXJlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29sb3JNYXRyaXhUZXh0dXJlU2hhcGVXaWR0aEhlaWdodChcbiAgICByb3dzOiBudW1iZXIsIGNvbHVtbnM6IG51bWJlcik6IFtudW1iZXIsIG51bWJlcl0ge1xuICByZXR1cm4gW2NvbHVtbnMgKiA0LCByb3dzXTtcbn1cblxuLyoqXG4gKiBHZXQgc2hhcGUgZm9yIGRlbnNlbHkgcGFja2VkIFJHQkEgdGV4dHVyZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldERlbnNlVGV4U2hhcGUoc2hhcGU6IG51bWJlcltdKTogW251bWJlciwgbnVtYmVyXSB7XG4gIGNvbnN0IHNpemUgPSB1dGlsLnNpemVGcm9tU2hhcGUoc2hhcGUpO1xuICBjb25zdCB0ZXhlbHNOZWVkZWQgPSBNYXRoLmNlaWwoc2l6ZSAvIDQpO1xuICByZXR1cm4gdXRpbC5zaXplVG9TcXVhcmlzaFNoYXBlKHRleGVsc05lZWRlZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNYXRyaXhTaXplRnJvbVVucGFja2VkQXJyYXlTaXplKFxuICAgIHVucGFja2VkU2l6ZTogbnVtYmVyLCBjaGFubmVsc1BlclRleHR1cmU6IG51bWJlcik6IG51bWJlciB7XG4gIGlmICh1bnBhY2tlZFNpemUgJSBjaGFubmVsc1BlclRleHR1cmUgIT09IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGB1bnBhY2tlZFNpemUgKCR7dW5wYWNrZWRTaXplfSkgbXVzdCBiZSBhIG11bHRpcGxlIG9mIGAgK1xuICAgICAgICBgJHtjaGFubmVsc1BlclRleHR1cmV9YCk7XG4gIH1cbiAgcmV0dXJuIHVucGFja2VkU2l6ZSAvIGNoYW5uZWxzUGVyVGV4dHVyZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZU1hdHJpeEZyb21VbnBhY2tlZENvbG9yUkdCQUFycmF5KFxuICAgIHVucGFja2VkQXJyYXk6IEZsb2F0MzJBcnJheSwgbWF0cml4OiBGbG9hdDMyQXJyYXksIGNoYW5uZWxzOiBudW1iZXIpIHtcbiAgY29uc3QgcmVxdWlyZWRTaXplID0gdW5wYWNrZWRBcnJheS5sZW5ndGggKiBjaGFubmVscyAvIDQ7XG4gIGlmIChtYXRyaXgubGVuZ3RoIDwgcmVxdWlyZWRTaXplKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgbWF0cml4IGxlbmd0aCAoJHttYXRyaXgubGVuZ3RofSkgbXVzdCBiZSA+PSAke3JlcXVpcmVkU2l6ZX1gKTtcbiAgfVxuICBsZXQgZHN0ID0gMDtcbiAgZm9yIChsZXQgc3JjID0gMDsgc3JjIDwgdW5wYWNrZWRBcnJheS5sZW5ndGg7IHNyYyArPSA0KSB7XG4gICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjaGFubmVsczsgYysrKSB7XG4gICAgICBtYXRyaXhbZHN0KytdID0gdW5wYWNrZWRBcnJheVtzcmMgKyBjXTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhY2tlZE1hdHJpeFRleHR1cmVTaGFwZVdpZHRoSGVpZ2h0KFxuICAgIHJvd3M6IG51bWJlciwgY29sdW1uczogbnVtYmVyKTogW251bWJlciwgbnVtYmVyXSB7XG4gIHJldHVybiBbXG4gICAgTWF0aC5tYXgoMSwgTWF0aC5jZWlsKGNvbHVtbnMgLyAyKSksIE1hdGgubWF4KDEsIE1hdGguY2VpbChyb3dzIC8gMikpXG4gIF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYWNrZWRSR0JBQXJyYXlTaXplRnJvbU1hdHJpeFNoYXBlKFxuICAgIHJvd3M6IG51bWJlciwgY29sdW1uczogbnVtYmVyKTogbnVtYmVyIHtcbiAgY29uc3QgW3csIGhdID0gZ2V0UGFja2VkTWF0cml4VGV4dHVyZVNoYXBlV2lkdGhIZWlnaHQocm93cywgY29sdW1ucyk7XG4gIHJldHVybiB3ICogaCAqIDQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGV4dHVyZUNvbmZpZyB7XG4gIGludGVybmFsRm9ybWF0RmxvYXQ6IG51bWJlcjtcbiAgdGV4dHVyZUZvcm1hdEZsb2F0OiBudW1iZXI7XG4gIGludGVybmFsRm9ybWF0UGFja2VkSGFsZkZsb2F0OiBudW1iZXI7XG4gIGludGVybmFsRm9ybWF0SGFsZkZsb2F0OiBudW1iZXI7XG4gIGludGVybmFsRm9ybWF0UGFja2VkRmxvYXQ6IG51bWJlcjtcblxuICAvLyBUaGUgZm9ybWF0IHRvIHVzZSBkdXJpbmcgYSBnbC5yZWFkUGl4ZWxzIGNhbGwuXG4gIGRvd25sb2FkVGV4dHVyZUZvcm1hdDogbnVtYmVyO1xuICAvLyBIb3cgbWFueSBjaGFubmVscyBuZWVkIHRvIGJlIHVucGFja2VkIGFmdGVyIGEgZ2wucmVhZFBpeGVscyBjYWxsLlxuICBkb3dubG9hZFVucGFja051bUNoYW5uZWxzOiBudW1iZXI7XG5cbiAgZGVmYXVsdE51bUNoYW5uZWxzOiBudW1iZXI7XG4gIHRleHR1cmVUeXBlSGFsZkZsb2F0OiBudW1iZXI7XG4gIHRleHR1cmVUeXBlRmxvYXQ6IG51bWJlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRleHR1cmVDb25maWcoXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgIGdsOiBXZWJHTFJlbmRlcmluZ0NvbnRleHQsIHRleHR1cmVIYWxmRmxvYXRFeHRlbnNpb24/OiBhbnkpOiBUZXh0dXJlQ29uZmlnIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICBjb25zdCBnbGFueSA9IGdsIGFzIGFueTtcblxuICBsZXQgaW50ZXJuYWxGb3JtYXRGbG9hdDogbnVtYmVyO1xuICBsZXQgaW50ZXJuYWxGb3JtYXRIYWxmRmxvYXQ6IG51bWJlcjtcbiAgbGV0IGludGVybmFsRm9ybWF0UGFja2VkSGFsZkZsb2F0OiBudW1iZXI7XG4gIGxldCBpbnRlcm5hbEZvcm1hdFBhY2tlZEZsb2F0OiBudW1iZXI7XG4gIGxldCB0ZXh0dXJlRm9ybWF0RmxvYXQ6IG51bWJlcjtcblxuICBsZXQgZG93bmxvYWRUZXh0dXJlRm9ybWF0OiBudW1iZXI7XG4gIGxldCBkb3dubG9hZFVucGFja051bUNoYW5uZWxzOiBudW1iZXI7XG5cbiAgbGV0IGRlZmF1bHROdW1DaGFubmVsczogbnVtYmVyO1xuICBsZXQgdGV4dHVyZVR5cGVIYWxmRmxvYXQ6IG51bWJlcjtcbiAgbGV0IHRleHR1cmVUeXBlRmxvYXQ6IG51bWJlcjtcblxuICBpZiAoZW52KCkuZ2V0TnVtYmVyKCdXRUJHTF9WRVJTSU9OJykgPT09IDIpIHtcbiAgICBpbnRlcm5hbEZvcm1hdEZsb2F0ID0gZ2xhbnkuUjMyRjtcbiAgICBpbnRlcm5hbEZvcm1hdEhhbGZGbG9hdCA9IGdsYW55LlIxNkY7XG4gICAgaW50ZXJuYWxGb3JtYXRQYWNrZWRIYWxmRmxvYXQgPSBnbGFueS5SR0JBMTZGO1xuICAgIGludGVybmFsRm9ybWF0UGFja2VkRmxvYXQgPSBnbGFueS5SR0JBMzJGO1xuICAgIHRleHR1cmVGb3JtYXRGbG9hdCA9IGdsYW55LlJFRDtcbiAgICBkb3dubG9hZFVucGFja051bUNoYW5uZWxzID0gNDtcbiAgICBkZWZhdWx0TnVtQ2hhbm5lbHMgPSAxO1xuICAgIHRleHR1cmVUeXBlSGFsZkZsb2F0ID0gZ2xhbnkuSEFMRl9GTE9BVDtcbiAgICB0ZXh0dXJlVHlwZUZsb2F0ID0gZ2xhbnkuRkxPQVQ7XG4gIH0gZWxzZSB7XG4gICAgaW50ZXJuYWxGb3JtYXRGbG9hdCA9IGdsLlJHQkE7XG4gICAgaW50ZXJuYWxGb3JtYXRIYWxmRmxvYXQgPSBnbC5SR0JBO1xuICAgIGludGVybmFsRm9ybWF0UGFja2VkSGFsZkZsb2F0ID0gZ2wuUkdCQTtcbiAgICBpbnRlcm5hbEZvcm1hdFBhY2tlZEZsb2F0ID0gZ2xhbnkuUkdCQTtcbiAgICB0ZXh0dXJlRm9ybWF0RmxvYXQgPSBnbC5SR0JBO1xuICAgIGRvd25sb2FkVW5wYWNrTnVtQ2hhbm5lbHMgPSA0O1xuICAgIGRlZmF1bHROdW1DaGFubmVscyA9IDQ7XG4gICAgdGV4dHVyZVR5cGVIYWxmRmxvYXQgPSB0ZXh0dXJlSGFsZkZsb2F0RXh0ZW5zaW9uICE9IG51bGwgP1xuICAgICAgICB0ZXh0dXJlSGFsZkZsb2F0RXh0ZW5zaW9uLkhBTEZfRkxPQVRfT0VTIDpcbiAgICAgICAgbnVsbDtcbiAgICB0ZXh0dXJlVHlwZUZsb2F0ID0gZ2wuRkxPQVQ7XG4gIH1cbiAgZG93bmxvYWRUZXh0dXJlRm9ybWF0ID0gZ2wuUkdCQTtcblxuICByZXR1cm4ge1xuICAgIGludGVybmFsRm9ybWF0RmxvYXQsXG4gICAgaW50ZXJuYWxGb3JtYXRIYWxmRmxvYXQsXG4gICAgaW50ZXJuYWxGb3JtYXRQYWNrZWRIYWxmRmxvYXQsXG4gICAgaW50ZXJuYWxGb3JtYXRQYWNrZWRGbG9hdCxcbiAgICB0ZXh0dXJlRm9ybWF0RmxvYXQsXG4gICAgZG93bmxvYWRUZXh0dXJlRm9ybWF0LFxuICAgIGRvd25sb2FkVW5wYWNrTnVtQ2hhbm5lbHMsXG4gICAgZGVmYXVsdE51bUNoYW5uZWxzLFxuICAgIHRleHR1cmVUeXBlSGFsZkZsb2F0LFxuICAgIHRleHR1cmVUeXBlRmxvYXRcbiAgfTtcbn1cbiJdfQ==